

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>utils.indicators &mdash; QuantLab Documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=e9ebdb8f"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            QuantLab
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../core.html">Core Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../strategies.html">Strategies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../utils.html">Utilities</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../runners.html">Runners</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">QuantLab</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">utils.indicators</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for utils.indicators</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Unified Technical Analysis Indicators - Single Source of Truth.</span>

<span class="sd">Consolidated collection of all 22+ technical indicators matching PineScript.</span>
<span class="sd">NO REDUNDANCIES - single source for all indicators.</span>

<span class="sd">Categories:</span>
<span class="sd">- Moving Averages: SMA, EMA, WMA, HMA</span>
<span class="sd">- Momentum: RSI, MACD, Stochastic, StochasticRSI, Momentum, ChandeOscillator, UltimateOscillator</span>
<span class="sd">- Trend: ATR, ADX, Aroon, DonchianChannels, Supertrend, Ichimoku</span>
<span class="sd">- Volume: VWAP, MFI, CMF, OBV, VWMA</span>
<span class="sd">- Oscillators: WilliamsR, CCI, BullBearPower</span>
<span class="sd">- Volatility/Bands: BollingerBands, Envelope, KeltnerChannels</span>
<span class="sd">- Special: ParabolicSAR, HullMovingAverage</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Union</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>


<span class="c1"># Moving Averages</span>
<div class="viewcode-block" id="SMA">
<a class="viewcode-back" href="../../utils.html#utils.indicators.SMA">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">SMA</span><span class="p">(</span><span class="n">series</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="n">n</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Simple Moving Average.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">series</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="n">series</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">series</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">series</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="n">n</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">values</span></div>



<div class="viewcode-block" id="EMA">
<a class="viewcode-back" href="../../utils.html#utils.indicators.EMA">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">EMA</span><span class="p">(</span><span class="n">values</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">n</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">alpha</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Exponential Moving Average. Uses alpha=2/(n+1) or 1/n for Wilder&#39;s smoothing.&quot;&quot;&quot;</span>
    <span class="n">values</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">values</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="s2">&quot;values&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="n">values</span>
    <span class="k">if</span> <span class="n">alpha</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">/</span> <span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty_like</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)):</span>
        <span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">alpha</span> <span class="o">*</span> <span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">alpha</span><span class="p">)</span> <span class="o">*</span> <span class="n">result</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">result</span></div>



<div class="viewcode-block" id="WMA">
<a class="viewcode-back" href="../../utils.html#utils.indicators.WMA">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">WMA</span><span class="p">(</span><span class="n">values</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">n</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Weighted Moving Average - linearly weighted.&quot;&quot;&quot;</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)):</span>
        <span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="n">n</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="n">weights</span><span class="p">)</span> <span class="o">/</span> <span class="n">weights</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">result</span></div>



<div class="viewcode-block" id="HullMovingAverage">
<a class="viewcode-back" href="../../utils.html#utils.indicators.HullMovingAverage">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">HullMovingAverage</span><span class="p">(</span><span class="n">close</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">9</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Hull Moving Average - low-lag moving average.&quot;&quot;&quot;</span>
    <span class="n">half_period</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">period</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">sqrt_period</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">period</span><span class="p">))</span>

    <span class="n">wma_half</span> <span class="o">=</span> <span class="n">WMA</span><span class="p">(</span><span class="n">close</span><span class="p">,</span> <span class="n">half_period</span><span class="p">)</span>
    <span class="n">wma_full</span> <span class="o">=</span> <span class="n">WMA</span><span class="p">(</span><span class="n">close</span><span class="p">,</span> <span class="n">period</span><span class="p">)</span>
    <span class="n">combined</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">wma_half</span> <span class="o">-</span> <span class="n">wma_full</span>

    <span class="n">hma</span> <span class="o">=</span> <span class="n">WMA</span><span class="p">(</span><span class="n">combined</span><span class="p">,</span> <span class="n">sqrt_period</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">hma</span><span class="p">,</span> <span class="n">nan</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></div>



<div class="viewcode-block" id="DEMA">
<a class="viewcode-back" href="../../utils.html#utils.indicators.DEMA">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">DEMA</span><span class="p">(</span><span class="n">close</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">length</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">200</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Double Exponential Moving Average (DEMA).</span>
<span class="sd">    </span>
<span class="sd">    DEMA = 2 * EMA(close, length) - EMA(EMA(close, length), length)</span>
<span class="sd">    Reduces lag compared to standard EMA.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">e1</span> <span class="o">=</span> <span class="n">EMA</span><span class="p">(</span><span class="n">close</span><span class="p">,</span> <span class="n">length</span><span class="p">)</span>
    <span class="n">e2</span> <span class="o">=</span> <span class="n">EMA</span><span class="p">(</span><span class="n">e1</span><span class="p">,</span> <span class="n">length</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">e1</span> <span class="o">-</span> <span class="n">e2</span></div>



<div class="viewcode-block" id="TEMA">
<a class="viewcode-back" href="../../utils.html#utils.indicators.TEMA">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">TEMA</span><span class="p">(</span><span class="n">series</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">length</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Triple Exponential Moving Average (TEMA).</span>
<span class="sd">    </span>
<span class="sd">    TEMA = 3*EMA1 - 3*EMA2 + EMA3</span>
<span class="sd">    </span>
<span class="sd">    Provides even less lag than DEMA while maintaining smoothness.</span>
<span class="sd">    Used in trend-following strategies for faster signal generation.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        series: Price array (typically close prices)</span>
<span class="sd">        length: EMA period</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        TEMA values as numpy array</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">length</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">series</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">ema1</span> <span class="o">=</span> <span class="n">EMA</span><span class="p">(</span><span class="n">series</span><span class="p">,</span> <span class="n">length</span><span class="p">)</span>
    <span class="n">ema2</span> <span class="o">=</span> <span class="n">EMA</span><span class="p">(</span><span class="n">ema1</span><span class="p">,</span> <span class="n">length</span><span class="p">)</span>
    <span class="n">ema3</span> <span class="o">=</span> <span class="n">EMA</span><span class="p">(</span><span class="n">ema2</span><span class="p">,</span> <span class="n">length</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">ema1</span> <span class="o">-</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">ema2</span> <span class="o">+</span> <span class="n">ema3</span></div>



<div class="viewcode-block" id="LSMA">
<a class="viewcode-back" href="../../utils.html#utils.indicators.LSMA">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">LSMA</span><span class="p">(</span><span class="n">series</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">length</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Least Squares Moving Average (Linear Regression).</span>
<span class="sd">    </span>
<span class="sd">    Also known as Linear Regression Curve or End Point Moving Average.</span>
<span class="sd">    Fits a linear regression line over the lookback period and returns</span>
<span class="sd">    the end point of that line.</span>
<span class="sd">    </span>
<span class="sd">    Provides smooth trend indication with minimal lag.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        series: Price array (typically close prices)</span>
<span class="sd">        length: Lookback period for linear regression</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        LSMA values as numpy array</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">length</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">series</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">series</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">length</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">result</span>
    
    <span class="c1"># Precompute x statistics (constant for all windows)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">x_mean</span> <span class="o">=</span> <span class="p">(</span><span class="n">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span>
    <span class="n">x_var</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="n">x_mean</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">series</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="n">length</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">y_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        <span class="n">slope</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="n">x_mean</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">y_mean</span><span class="p">))</span> <span class="o">/</span> <span class="n">x_var</span>
        <span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">slope</span> <span class="o">*</span> <span class="p">(</span><span class="n">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">y_mean</span> <span class="o">-</span> <span class="n">slope</span> <span class="o">*</span> <span class="n">x_mean</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">result</span></div>



<span class="c1"># Momentum Indicators</span>
<div class="viewcode-block" id="RSI">
<a class="viewcode-back" href="../../utils.html#utils.indicators.RSI">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">RSI</span><span class="p">(</span><span class="n">series</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="n">n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">14</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;RSI with Wilder&#39;s smoothing matching TradingView. Range: 0-100.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">series</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">):</span>
        <span class="n">values</span> <span class="o">=</span> <span class="n">series</span><span class="o">.</span><span class="n">values</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">series</span><span class="p">)</span>

    <span class="n">delta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">prepend</span><span class="o">=</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">gain</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">delta</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">delta</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">delta</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">delta</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="n">avg_gain</span> <span class="o">=</span> <span class="n">EMA</span><span class="p">(</span><span class="n">gain</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">n</span><span class="p">)</span>
    <span class="n">avg_loss</span> <span class="o">=</span> <span class="n">EMA</span><span class="p">(</span><span class="n">loss</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">n</span><span class="p">)</span>

    <span class="c1"># Suppress division warnings - we handle zero loss with np.where</span>
    <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">errstate</span><span class="p">(</span><span class="n">divide</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">invalid</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">):</span>
        <span class="n">rs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">avg_loss</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">avg_gain</span> <span class="o">/</span> <span class="n">avg_loss</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">rsi</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">-</span> <span class="p">(</span><span class="mi">100</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">rs</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">rsi</span><span class="p">,</span> <span class="n">nan</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span></div>



<div class="viewcode-block" id="MACD">
<a class="viewcode-back" href="../../utils.html#utils.indicators.MACD">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">MACD</span><span class="p">(</span><span class="n">values</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">fast</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span> <span class="n">slow</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">26</span><span class="p">,</span> <span class="n">signal</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">9</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;MACD - returns dict with macd, signal, histogram.&quot;&quot;&quot;</span>
    <span class="n">ema_fast</span> <span class="o">=</span> <span class="n">EMA</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">fast</span><span class="p">)</span>
    <span class="n">ema_slow</span> <span class="o">=</span> <span class="n">EMA</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">slow</span><span class="p">)</span>
    <span class="n">macd_line</span> <span class="o">=</span> <span class="n">ema_fast</span> <span class="o">-</span> <span class="n">ema_slow</span>
    <span class="n">signal_line</span> <span class="o">=</span> <span class="n">EMA</span><span class="p">(</span><span class="n">macd_line</span><span class="p">,</span> <span class="n">signal</span><span class="p">)</span>
    <span class="n">histogram</span> <span class="o">=</span> <span class="n">macd_line</span> <span class="o">-</span> <span class="n">signal_line</span>

    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;macd&quot;</span><span class="p">:</span> <span class="n">macd_line</span><span class="p">,</span> <span class="s2">&quot;signal&quot;</span><span class="p">:</span> <span class="n">signal_line</span><span class="p">,</span> <span class="s2">&quot;histogram&quot;</span><span class="p">:</span> <span class="n">histogram</span><span class="p">}</span></div>



<div class="viewcode-block" id="Stochastic">
<a class="viewcode-back" href="../../utils.html#utils.indicators.Stochastic">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">Stochastic</span><span class="p">(</span>
    <span class="n">high</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">low</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">close</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">period_k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">14</span><span class="p">,</span>
    <span class="n">smooth_k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">period_d</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Stochastic Oscillator - returns k and d lines. Range: 0-100.&quot;&quot;&quot;</span>
    <span class="n">highest_high</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">high</span><span class="p">)</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="n">period_k</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>
    <span class="n">lowest_low</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">low</span><span class="p">)</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="n">period_k</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>

    <span class="n">range_val</span> <span class="o">=</span> <span class="n">highest_high</span> <span class="o">-</span> <span class="n">lowest_low</span>
    <span class="n">stoch_raw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">range_val</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">((</span><span class="n">close</span> <span class="o">-</span> <span class="n">lowest_low</span><span class="p">)</span> <span class="o">/</span> <span class="n">range_val</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>

    <span class="n">k</span> <span class="o">=</span> <span class="n">SMA</span><span class="p">(</span><span class="n">stoch_raw</span><span class="p">,</span> <span class="n">smooth_k</span><span class="p">)</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">SMA</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">period_d</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;k&quot;</span><span class="p">:</span> <span class="n">k</span><span class="p">,</span> <span class="s2">&quot;d&quot;</span><span class="p">:</span> <span class="n">d</span><span class="p">}</span></div>



<div class="viewcode-block" id="StochasticRSI">
<a class="viewcode-back" href="../../utils.html#utils.indicators.StochasticRSI">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">StochasticRSI</span><span class="p">(</span>
    <span class="n">close</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">rsi_length</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">14</span><span class="p">,</span>
    <span class="n">stoch_length</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">14</span><span class="p">,</span>
    <span class="n">k_smooth</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
    <span class="n">d_smooth</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Stochastic RSI - Stochastic applied to RSI values.&quot;&quot;&quot;</span>
    <span class="n">rsi_vals</span> <span class="o">=</span> <span class="n">RSI</span><span class="p">(</span><span class="n">close</span><span class="p">,</span> <span class="n">rsi_length</span><span class="p">)</span>

    <span class="n">rsi_series</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">rsi_vals</span><span class="p">)</span>
    <span class="n">highest_rsi</span> <span class="o">=</span> <span class="n">rsi_series</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="n">stoch_length</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>
    <span class="n">lowest_rsi</span> <span class="o">=</span> <span class="n">rsi_series</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="n">stoch_length</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>

    <span class="n">range_val</span> <span class="o">=</span> <span class="n">highest_rsi</span> <span class="o">-</span> <span class="n">lowest_rsi</span>
    <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">errstate</span><span class="p">(</span><span class="n">divide</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">invalid</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">):</span>
        <span class="n">stoch_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">range_val</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">((</span><span class="n">rsi_vals</span> <span class="o">-</span> <span class="n">lowest_rsi</span><span class="p">)</span> <span class="o">/</span> <span class="n">range_val</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">50</span>
        <span class="p">)</span>

    <span class="n">k</span> <span class="o">=</span> <span class="n">SMA</span><span class="p">(</span><span class="n">stoch_vals</span><span class="p">,</span> <span class="n">k_smooth</span><span class="p">)</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">SMA</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">d_smooth</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;k&quot;</span><span class="p">:</span> <span class="n">k</span><span class="p">,</span> <span class="s2">&quot;d&quot;</span><span class="p">:</span> <span class="n">d</span><span class="p">}</span></div>



<div class="viewcode-block" id="StochasticRSI_from_RSI">
<a class="viewcode-back" href="../../utils.html#utils.indicators.StochasticRSI_from_RSI">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">StochasticRSI_from_RSI</span><span class="p">(</span>
    <span class="n">rsi</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">stoch_length</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">14</span><span class="p">,</span>
    <span class="n">k_smooth</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
    <span class="n">d_smooth</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Stochastic RSI from pre-computed RSI values.</span>
<span class="sd">    </span>
<span class="sd">    Use this when you already have RSI calculated and want to apply</span>
<span class="sd">    Stochastic calculation to it without recalculating RSI.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        rsi: Pre-computed RSI values</span>
<span class="sd">        stoch_length: Lookback period for Stochastic (default: 14)</span>
<span class="sd">        k_smooth: Smoothing period for %K (default: 3)</span>
<span class="sd">        d_smooth: Smoothing period for %D (default: 3)</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        Dictionary with &#39;k&#39; and &#39;d&#39; values</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rsi_series</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">rsi</span><span class="p">)</span>
    <span class="n">highest_rsi</span> <span class="o">=</span> <span class="n">rsi_series</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="n">stoch_length</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>
    <span class="n">lowest_rsi</span> <span class="o">=</span> <span class="n">rsi_series</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="n">stoch_length</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>

    <span class="n">range_val</span> <span class="o">=</span> <span class="n">highest_rsi</span> <span class="o">-</span> <span class="n">lowest_rsi</span>
    <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">errstate</span><span class="p">(</span><span class="n">divide</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">invalid</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">):</span>
        <span class="n">stoch_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">range_val</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">((</span><span class="n">rsi</span> <span class="o">-</span> <span class="n">lowest_rsi</span><span class="p">)</span> <span class="o">/</span> <span class="n">range_val</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">50</span>
        <span class="p">)</span>

    <span class="n">k</span> <span class="o">=</span> <span class="n">SMA</span><span class="p">(</span><span class="n">stoch_vals</span><span class="p">,</span> <span class="n">k_smooth</span><span class="p">)</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">SMA</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">d_smooth</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;k&quot;</span><span class="p">:</span> <span class="n">k</span><span class="p">,</span> <span class="s2">&quot;d&quot;</span><span class="p">:</span> <span class="n">d</span><span class="p">}</span></div>



<div class="viewcode-block" id="Momentum">
<a class="viewcode-back" href="../../utils.html#utils.indicators.Momentum">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">Momentum</span><span class="p">(</span><span class="n">close</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Momentum - price change over period.&quot;&quot;&quot;</span>
    <span class="n">momentum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">close</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">prepend</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="n">momentum</span><span class="p">[</span><span class="n">period</span><span class="p">:]</span> <span class="o">=</span> <span class="n">close</span><span class="p">[</span><span class="n">period</span><span class="p">:]</span> <span class="o">-</span> <span class="n">close</span><span class="p">[:</span><span class="o">-</span><span class="n">period</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">momentum</span></div>



<div class="viewcode-block" id="ChandeOscillator">
<a class="viewcode-back" href="../../utils.html#utils.indicators.ChandeOscillator">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">ChandeOscillator</span><span class="p">(</span><span class="n">close</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">9</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Chande Momentum Oscillator. Range: -100 to +100.&quot;&quot;&quot;</span>
    <span class="n">momentum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">close</span><span class="p">,</span> <span class="n">prepend</span><span class="o">=</span><span class="n">close</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="n">positive_mom</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">momentum</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">momentum</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">negative_mom</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">momentum</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">momentum</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="n">sum_positive</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">positive_mom</span><span class="p">)</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">period</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>
    <span class="n">sum_negative</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">negative_mom</span><span class="p">)</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">period</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>

    <span class="n">total_sum</span> <span class="o">=</span> <span class="n">sum_positive</span> <span class="o">+</span> <span class="n">sum_negative</span>
    <span class="n">cmo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">total_sum</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">100</span> <span class="o">*</span> <span class="p">(</span><span class="n">sum_positive</span> <span class="o">-</span> <span class="n">sum_negative</span><span class="p">)</span> <span class="o">/</span> <span class="n">total_sum</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">cmo</span><span class="p">,</span> <span class="n">nan</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></div>



<div class="viewcode-block" id="UltimateOscillator">
<a class="viewcode-back" href="../../utils.html#utils.indicators.UltimateOscillator">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">UltimateOscillator</span><span class="p">(</span>
    <span class="n">high</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">low</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">close</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">fast_length</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">7</span><span class="p">,</span>
    <span class="n">middle_length</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">14</span><span class="p">,</span>
    <span class="n">slow_length</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">28</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Ultimate Oscillator - multi-timeframe momentum. Range: 0-100.&quot;&quot;&quot;</span>
    <span class="n">close</span> <span class="o">=</span> <span class="n">close</span><span class="o">.</span><span class="n">values</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">close</span><span class="p">,</span> <span class="s2">&quot;values&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="n">close</span>
    <span class="n">prev_close</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(([</span><span class="n">close</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">close</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">tr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">high</span><span class="p">,</span> <span class="n">prev_close</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">low</span><span class="p">,</span> <span class="n">prev_close</span><span class="p">)</span>
    <span class="n">bp</span> <span class="o">=</span> <span class="n">close</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">low</span><span class="p">,</span> <span class="n">prev_close</span><span class="p">)</span>

    <span class="n">bp_fast</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">fast_length</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>
    <span class="n">tr_fast</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">tr</span><span class="p">)</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">fast_length</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>
    <span class="n">avg_fast</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">tr_fast</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">bp_fast</span> <span class="o">/</span> <span class="n">tr_fast</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="n">bp_middle</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">middle_length</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>
    <span class="n">tr_middle</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">tr</span><span class="p">)</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">middle_length</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>
    <span class="n">avg_middle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">tr_middle</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">bp_middle</span> <span class="o">/</span> <span class="n">tr_middle</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="n">bp_slow</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">slow_length</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>
    <span class="n">tr_slow</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">tr</span><span class="p">)</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">slow_length</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>
    <span class="n">avg_slow</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">tr_slow</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">bp_slow</span> <span class="o">/</span> <span class="n">tr_slow</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="n">uo</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">avg_fast</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">avg_middle</span> <span class="o">+</span> <span class="n">avg_slow</span><span class="p">)</span> <span class="o">/</span> <span class="mi">7</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">uo</span><span class="p">,</span> <span class="n">nan</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span></div>



<span class="c1"># Trend Indicators</span>
<div class="viewcode-block" id="ATR">
<a class="viewcode-back" href="../../utils.html#utils.indicators.ATR">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">ATR</span><span class="p">(</span>
    <span class="n">high</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">low</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">close</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">14</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Average True Range - volatility measurement.&quot;&quot;&quot;</span>
    <span class="n">close</span> <span class="o">=</span> <span class="n">close</span><span class="o">.</span><span class="n">values</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">close</span><span class="p">,</span> <span class="s2">&quot;values&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="n">close</span>
    <span class="n">prev_close</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(([</span><span class="n">close</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">close</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">tr1</span> <span class="o">=</span> <span class="n">high</span> <span class="o">-</span> <span class="n">low</span>
    <span class="n">tr2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">high</span> <span class="o">-</span> <span class="n">prev_close</span><span class="p">)</span>
    <span class="n">tr3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">low</span> <span class="o">-</span> <span class="n">prev_close</span><span class="p">)</span>
    <span class="n">tr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">tr1</span><span class="p">,</span> <span class="n">tr2</span><span class="p">),</span> <span class="n">tr3</span><span class="p">)</span>

    <span class="n">atr</span> <span class="o">=</span> <span class="n">EMA</span><span class="p">(</span><span class="n">tr</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">period</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">atr</span><span class="p">,</span> <span class="n">nan</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></div>



<div class="viewcode-block" id="ADX">
<a class="viewcode-back" href="../../utils.html#utils.indicators.ADX">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">ADX</span><span class="p">(</span><span class="n">high</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">low</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">close</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">14</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ADX - Average Directional Index. Returns adx, di_plus, di_minus.&quot;&quot;&quot;</span>
    <span class="n">close</span> <span class="o">=</span> <span class="n">close</span><span class="o">.</span><span class="n">values</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">close</span><span class="p">,</span> <span class="s2">&quot;values&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="n">close</span>
    <span class="n">high</span> <span class="o">=</span> <span class="n">high</span><span class="o">.</span><span class="n">values</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">high</span><span class="p">,</span> <span class="s2">&quot;values&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="n">high</span>
    <span class="n">low</span> <span class="o">=</span> <span class="n">low</span><span class="o">.</span><span class="n">values</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">low</span><span class="p">,</span> <span class="s2">&quot;values&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="n">low</span>
    <span class="n">prev_close</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(([</span><span class="n">close</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">close</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">tr1</span> <span class="o">=</span> <span class="n">high</span> <span class="o">-</span> <span class="n">low</span>
    <span class="n">tr2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">high</span> <span class="o">-</span> <span class="n">prev_close</span><span class="p">)</span>
    <span class="n">tr3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">low</span> <span class="o">-</span> <span class="n">prev_close</span><span class="p">)</span>
    <span class="n">tr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">tr1</span><span class="p">,</span> <span class="n">tr2</span><span class="p">),</span> <span class="n">tr3</span><span class="p">)</span>

    <span class="n">prev_high</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(([</span><span class="n">high</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">high</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">prev_low</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(([</span><span class="n">low</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">low</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>

    <span class="n">plus_dm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
        <span class="p">(</span><span class="n">high</span> <span class="o">-</span> <span class="n">prev_high</span> <span class="o">&gt;</span> <span class="n">prev_low</span> <span class="o">-</span> <span class="n">low</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">high</span> <span class="o">-</span> <span class="n">prev_high</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">),</span>
        <span class="n">high</span> <span class="o">-</span> <span class="n">prev_high</span><span class="p">,</span>
        <span class="mi">0</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">minus_dm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
        <span class="p">(</span><span class="n">prev_low</span> <span class="o">-</span> <span class="n">low</span> <span class="o">&gt;</span> <span class="n">high</span> <span class="o">-</span> <span class="n">prev_high</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">prev_low</span> <span class="o">-</span> <span class="n">low</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">),</span> <span class="n">prev_low</span> <span class="o">-</span> <span class="n">low</span><span class="p">,</span> <span class="mi">0</span>
    <span class="p">)</span>

    <span class="n">tr_smooth</span> <span class="o">=</span> <span class="n">EMA</span><span class="p">(</span><span class="n">tr</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">period</span><span class="p">)</span>
    <span class="n">plus_dm_smooth</span> <span class="o">=</span> <span class="n">EMA</span><span class="p">(</span><span class="n">plus_dm</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">period</span><span class="p">)</span>
    <span class="n">minus_dm_smooth</span> <span class="o">=</span> <span class="n">EMA</span><span class="p">(</span><span class="n">minus_dm</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">period</span><span class="p">)</span>

    <span class="n">di_plus</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">plus_dm_smooth</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">tr_smooth</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">tr_smooth</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">di_minus</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">minus_dm_smooth</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">tr_smooth</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">tr_smooth</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">dx</span> <span class="o">=</span> <span class="p">(</span>
        <span class="mi">100</span>
        <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">di_plus</span> <span class="o">-</span> <span class="n">di_minus</span><span class="p">)</span>
        <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">di_plus</span> <span class="o">+</span> <span class="n">di_minus</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">di_plus</span> <span class="o">+</span> <span class="n">di_minus</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">adx</span> <span class="o">=</span> <span class="n">EMA</span><span class="p">(</span><span class="n">dx</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">period</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;adx&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">adx</span><span class="p">,</span> <span class="n">nan</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
        <span class="s2">&quot;di_plus&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">di_plus</span><span class="p">,</span> <span class="n">nan</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
        <span class="s2">&quot;di_minus&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">di_minus</span><span class="p">,</span> <span class="n">nan</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
    <span class="p">}</span></div>



<div class="viewcode-block" id="Aroon">
<a class="viewcode-back" href="../../utils.html#utils.indicators.Aroon">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">Aroon</span><span class="p">(</span><span class="n">high</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">low</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">14</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Aroon - trend timing indicator. Returns aroon_up, aroon_down, and aroon_oscillator.&quot;&quot;&quot;</span>
    <span class="n">aroon_up</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">high</span><span class="p">))</span>
    <span class="n">aroon_down</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">low</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">high</span><span class="p">)):</span>
        <span class="n">highest_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">high</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="n">period</span> <span class="p">:</span> <span class="n">i</span><span class="p">])</span>
        <span class="n">bars_since_high</span> <span class="o">=</span> <span class="n">i</span> <span class="o">-</span> <span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="n">period</span> <span class="o">+</span> <span class="n">highest_idx</span><span class="p">)</span>

        <span class="n">lowest_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">low</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="n">period</span> <span class="p">:</span> <span class="n">i</span><span class="p">])</span>
        <span class="n">bars_since_low</span> <span class="o">=</span> <span class="n">i</span> <span class="o">-</span> <span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="n">period</span> <span class="o">+</span> <span class="n">lowest_idx</span><span class="p">)</span>

        <span class="n">aroon_up</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="p">(</span><span class="n">period</span> <span class="o">-</span> <span class="n">bars_since_high</span><span class="p">)</span> <span class="o">/</span> <span class="n">period</span>
        <span class="n">aroon_down</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="p">(</span><span class="n">period</span> <span class="o">-</span> <span class="n">bars_since_low</span><span class="p">)</span> <span class="o">/</span> <span class="n">period</span>

    <span class="n">aroon_oscillator</span> <span class="o">=</span> <span class="n">aroon_up</span> <span class="o">-</span> <span class="n">aroon_down</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;aroon_up&quot;</span><span class="p">:</span> <span class="n">aroon_up</span><span class="p">,</span>
        <span class="s2">&quot;aroon_down&quot;</span><span class="p">:</span> <span class="n">aroon_down</span><span class="p">,</span>
        <span class="s2">&quot;aroon_oscillator&quot;</span><span class="p">:</span> <span class="n">aroon_oscillator</span><span class="p">,</span>
    <span class="p">}</span></div>



<div class="viewcode-block" id="DonchianChannels">
<a class="viewcode-back" href="../../utils.html#utils.indicators.DonchianChannels">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">DonchianChannels</span><span class="p">(</span><span class="n">high</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">low</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Donchian Channels - highest/lowest levels. Returns upper, lower, basis.&quot;&quot;&quot;</span>
    <span class="n">upper</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">high</span><span class="p">)</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="n">period</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>
    <span class="n">lower</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">low</span><span class="p">)</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="n">period</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>
    <span class="n">basis</span> <span class="o">=</span> <span class="p">(</span><span class="n">upper</span> <span class="o">+</span> <span class="n">lower</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span>

    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;upper&quot;</span><span class="p">:</span> <span class="n">upper</span><span class="p">,</span> <span class="s2">&quot;lower&quot;</span><span class="p">:</span> <span class="n">lower</span><span class="p">,</span> <span class="s2">&quot;basis&quot;</span><span class="p">:</span> <span class="n">basis</span><span class="p">}</span></div>



<div class="viewcode-block" id="Supertrend">
<a class="viewcode-back" href="../../utils.html#utils.indicators.Supertrend">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">Supertrend</span><span class="p">(</span>
    <span class="n">high</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">low</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">close</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">atr_period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
    <span class="n">factor</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">3.0</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Supertrend - ATR-based trend indicator. Returns supertrend and direction.&quot;&quot;&quot;</span>
    <span class="n">atr_vals</span> <span class="o">=</span> <span class="n">ATR</span><span class="p">(</span><span class="n">high</span><span class="p">,</span> <span class="n">low</span><span class="p">,</span> <span class="n">close</span><span class="p">,</span> <span class="n">atr_period</span><span class="p">)</span>

    <span class="n">hl_avg</span> <span class="o">=</span> <span class="p">(</span><span class="n">high</span> <span class="o">+</span> <span class="n">low</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span>
    <span class="n">basic_ub</span> <span class="o">=</span> <span class="n">hl_avg</span> <span class="o">+</span> <span class="n">factor</span> <span class="o">*</span> <span class="n">atr_vals</span>
    <span class="n">basic_lb</span> <span class="o">=</span> <span class="n">hl_avg</span> <span class="o">-</span> <span class="n">factor</span> <span class="o">*</span> <span class="n">atr_vals</span>

    <span class="n">final_ub</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">close</span><span class="p">))</span>
    <span class="n">final_lb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">close</span><span class="p">))</span>
    <span class="n">supertrend</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">close</span><span class="p">))</span>
    <span class="n">direction</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">close</span><span class="p">))</span>

    <span class="n">final_ub</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">basic_ub</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">final_lb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">basic_lb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">supertrend</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">basic_ub</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">direction</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">close</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">basic_ub</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">final_ub</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="ow">or</span> <span class="n">close</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">final_ub</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]:</span>
            <span class="n">final_ub</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">basic_ub</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">final_ub</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">final_ub</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">basic_lb</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">final_lb</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="ow">or</span> <span class="n">close</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">final_lb</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]:</span>
            <span class="n">final_lb</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">basic_lb</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">final_lb</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">final_lb</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">supertrend</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">final_ub</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">close</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">final_ub</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                <span class="n">supertrend</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">final_ub</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">direction</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">supertrend</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">final_lb</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">direction</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">close</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">final_lb</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                <span class="n">supertrend</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">final_lb</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">direction</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">supertrend</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">final_ub</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">direction</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;supertrend&quot;</span><span class="p">:</span> <span class="n">supertrend</span><span class="p">,</span> <span class="s2">&quot;direction&quot;</span><span class="p">:</span> <span class="n">direction</span><span class="p">}</span></div>



<div class="viewcode-block" id="IchimokuKinkoHyo">
<a class="viewcode-back" href="../../utils.html#utils.indicators.IchimokuKinkoHyo">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">IchimokuKinkoHyo</span><span class="p">(</span>
    <span class="n">high</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">low</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">close</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">tenkan_period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">9</span><span class="p">,</span>
    <span class="n">kijun_period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">26</span><span class="p">,</span>
    <span class="n">senkou_span_b_period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">52</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Ichimoku Cloud - returns all 5 components.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">donchian_middle</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">period</span><span class="p">):</span>
        <span class="n">high_roll</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">h</span><span class="p">)</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">period</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>
        <span class="n">low_roll</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">l</span><span class="p">)</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">period</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">high_roll</span> <span class="o">+</span> <span class="n">low_roll</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>

    <span class="n">tenkan_sen</span> <span class="o">=</span> <span class="n">donchian_middle</span><span class="p">(</span><span class="n">high</span><span class="p">,</span> <span class="n">low</span><span class="p">,</span> <span class="n">tenkan_period</span><span class="p">)</span>
    <span class="n">kijun_sen</span> <span class="o">=</span> <span class="n">donchian_middle</span><span class="p">(</span><span class="n">high</span><span class="p">,</span> <span class="n">low</span><span class="p">,</span> <span class="n">kijun_period</span><span class="p">)</span>

    <span class="n">senkou_span_a</span> <span class="o">=</span> <span class="p">(</span><span class="n">tenkan_sen</span> <span class="o">+</span> <span class="n">kijun_sen</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">senkou_span_b</span> <span class="o">=</span> <span class="n">donchian_middle</span><span class="p">(</span><span class="n">high</span><span class="p">,</span> <span class="n">low</span><span class="p">,</span> <span class="n">senkou_span_b_period</span><span class="p">)</span>
    <span class="n">chikou_span</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">close</span><span class="p">,</span> <span class="o">-</span><span class="n">kijun_period</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;tenkan_sen&quot;</span><span class="p">:</span> <span class="n">tenkan_sen</span><span class="p">,</span>
        <span class="s2">&quot;kijun_sen&quot;</span><span class="p">:</span> <span class="n">kijun_sen</span><span class="p">,</span>
        <span class="s2">&quot;senkou_span_a&quot;</span><span class="p">:</span> <span class="n">senkou_span_a</span><span class="p">,</span>
        <span class="s2">&quot;senkou_span_b&quot;</span><span class="p">:</span> <span class="n">senkou_span_b</span><span class="p">,</span>
        <span class="s2">&quot;chikou_span&quot;</span><span class="p">:</span> <span class="n">chikou_span</span><span class="p">,</span>
    <span class="p">}</span></div>



<span class="c1"># Volume Indicators</span>
<div class="viewcode-block" id="VWAP">
<a class="viewcode-back" href="../../utils.html#utils.indicators.VWAP">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">VWAP</span><span class="p">(</span>
    <span class="n">high</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">low</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">close</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">volume</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Volume Weighted Average Price.&quot;&quot;&quot;</span>
    <span class="n">typical_price</span> <span class="o">=</span> <span class="p">(</span><span class="n">high</span> <span class="o">+</span> <span class="n">low</span> <span class="o">+</span> <span class="n">close</span><span class="p">)</span> <span class="o">/</span> <span class="mi">3</span>
    <span class="n">cumulative_tpv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">typical_price</span> <span class="o">*</span> <span class="n">volume</span><span class="p">)</span>
    <span class="n">cumulative_volume</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">volume</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">cumulative_tpv</span> <span class="o">/</span> <span class="n">cumulative_volume</span></div>



<div class="viewcode-block" id="MFI">
<a class="viewcode-back" href="../../utils.html#utils.indicators.MFI">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">MFI</span><span class="p">(</span>
    <span class="n">high</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">low</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">close</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">volume</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">14</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Money Flow Index - volume-weighted RSI. Range: 0-100.&quot;&quot;&quot;</span>
    <span class="n">typical_price</span> <span class="o">=</span> <span class="p">(</span><span class="n">high</span> <span class="o">+</span> <span class="n">low</span> <span class="o">+</span> <span class="n">close</span><span class="p">)</span> <span class="o">/</span> <span class="mi">3</span>
    <span class="n">raw_money_flow</span> <span class="o">=</span> <span class="n">typical_price</span> <span class="o">*</span> <span class="n">volume</span>

    <span class="n">tp_diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">typical_price</span><span class="p">,</span> <span class="n">prepend</span><span class="o">=</span><span class="n">typical_price</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="n">positive_flow</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">tp_diff</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">raw_money_flow</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">positive_mf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">positive_flow</span><span class="p">)</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">period</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>

    <span class="n">negative_flow</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">tp_diff</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">raw_money_flow</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">negative_mf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">negative_flow</span><span class="p">)</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">period</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>

    <span class="n">money_flow_ratio</span> <span class="o">=</span> <span class="n">positive_mf</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">negative_mf</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">negative_mf</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">mfi</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">-</span> <span class="p">(</span><span class="mi">100</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">money_flow_ratio</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">mfi</span><span class="p">,</span> <span class="n">nan</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span></div>



<div class="viewcode-block" id="CMF">
<a class="viewcode-back" href="../../utils.html#utils.indicators.CMF">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">CMF</span><span class="p">(</span>
    <span class="n">high</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">low</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">close</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">volume</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Chaikin Money Flow - volume-weighted price momentum.&quot;&quot;&quot;</span>
    <span class="c1"># Fix division by zero: replace 0 spread (high == low) with nan before division</span>
    <span class="n">spread</span> <span class="o">=</span> <span class="n">high</span> <span class="o">-</span> <span class="n">low</span>
    <span class="n">spread</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">spread</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">spread</span><span class="p">)</span>
    <span class="n">money_flow_multiplier</span> <span class="o">=</span> <span class="p">((</span><span class="n">close</span> <span class="o">-</span> <span class="n">low</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">high</span> <span class="o">-</span> <span class="n">close</span><span class="p">))</span> <span class="o">/</span> <span class="n">spread</span>
    <span class="n">money_flow_multiplier</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">money_flow_multiplier</span><span class="p">)</span>

    <span class="n">money_flow_volume</span> <span class="o">=</span> <span class="n">money_flow_multiplier</span> <span class="o">*</span> <span class="n">volume</span>

    <span class="n">cmf</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">money_flow_volume</span><span class="p">)</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">period</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="o">/</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">volume</span><span class="p">)</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">period</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="p">)</span><span class="o">.</span><span class="n">values</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">cmf</span><span class="p">,</span> <span class="n">nan</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></div>



<div class="viewcode-block" id="OBV">
<a class="viewcode-back" href="../../utils.html#utils.indicators.OBV">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">OBV</span><span class="p">(</span><span class="n">close</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">volume</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;On Balance Volume - cumulative volume indicator.&quot;&quot;&quot;</span>
    <span class="n">price_change</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">close</span><span class="p">,</span> <span class="n">prepend</span><span class="o">=</span><span class="n">close</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">sign</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">price_change</span><span class="p">)</span>
    <span class="n">obv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">sign</span> <span class="o">*</span> <span class="n">volume</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">obv</span></div>



<div class="viewcode-block" id="VWMA">
<a class="viewcode-back" href="../../utils.html#utils.indicators.VWMA">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">VWMA</span><span class="p">(</span><span class="n">close</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">volume</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">14</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Volume Weighted Moving Average.&quot;&quot;&quot;</span>
    <span class="n">pv</span> <span class="o">=</span> <span class="n">close</span> <span class="o">*</span> <span class="n">volume</span>
    <span class="n">vwma</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">pv</span><span class="p">)</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">period</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">volume</span><span class="p">)</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">period</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">vwma</span><span class="o">.</span><span class="n">values</span></div>



<span class="c1"># Oscillators</span>
<div class="viewcode-block" id="WilliamsR">
<a class="viewcode-back" href="../../utils.html#utils.indicators.WilliamsR">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">WilliamsR</span><span class="p">(</span>
    <span class="n">high</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">low</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">close</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">14</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Williams %R - overbought/oversold. Range: -100 to 0.&quot;&quot;&quot;</span>
    <span class="n">highest_high</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">high</span><span class="p">)</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="n">period</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>
    <span class="n">lowest_low</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">low</span><span class="p">)</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="n">period</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>

    <span class="n">range_val</span> <span class="o">=</span> <span class="n">highest_high</span> <span class="o">-</span> <span class="n">lowest_low</span>

    <span class="n">williams_r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
        <span class="n">range_val</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">100</span> <span class="o">*</span> <span class="p">(</span><span class="n">highest_high</span> <span class="o">-</span> <span class="n">close</span><span class="p">)</span> <span class="o">/</span> <span class="n">range_val</span><span class="p">,</span> <span class="o">-</span><span class="mi">50</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">williams_r</span><span class="p">,</span> <span class="n">nan</span><span class="o">=-</span><span class="mi">50</span><span class="p">)</span></div>



<div class="viewcode-block" id="CCI">
<a class="viewcode-back" href="../../utils.html#utils.indicators.CCI">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">CCI</span><span class="p">(</span>
    <span class="n">high</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">low</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">close</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Commodity Channel Index - deviation-based momentum.&quot;&quot;&quot;</span>
    <span class="n">tp</span> <span class="o">=</span> <span class="p">(</span><span class="n">high</span> <span class="o">+</span> <span class="n">low</span> <span class="o">+</span> <span class="n">close</span><span class="p">)</span> <span class="o">/</span> <span class="mi">3</span>
    <span class="n">tp_series</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">tp</span><span class="p">)</span>

    <span class="n">sma_tp</span> <span class="o">=</span> <span class="n">tp_series</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">period</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">mad</span> <span class="o">=</span> <span class="n">tp_series</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">period</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">x</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>

    <span class="n">cci</span> <span class="o">=</span> <span class="p">(</span><span class="n">tp_series</span> <span class="o">-</span> <span class="n">sma_tp</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">0.015</span> <span class="o">*</span> <span class="n">mad</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">cci</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">nan</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></div>



<div class="viewcode-block" id="BullBearPower">
<a class="viewcode-back" href="../../utils.html#utils.indicators.BullBearPower">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">BullBearPower</span><span class="p">(</span>
    <span class="n">high</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">low</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">close</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">length</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">13</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Bull Bear Power - buying vs selling pressure vs EMA.&quot;&quot;&quot;</span>
    <span class="n">ema_val</span> <span class="o">=</span> <span class="n">EMA</span><span class="p">(</span><span class="n">close</span><span class="p">,</span> <span class="n">length</span><span class="p">)</span>

    <span class="n">bull_power</span> <span class="o">=</span> <span class="n">high</span> <span class="o">-</span> <span class="n">ema_val</span>
    <span class="n">bear_power</span> <span class="o">=</span> <span class="n">low</span> <span class="o">-</span> <span class="n">ema_val</span>
    <span class="n">bbp</span> <span class="o">=</span> <span class="n">bull_power</span> <span class="o">+</span> <span class="n">bear_power</span>

    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;bull_power&quot;</span><span class="p">:</span> <span class="n">bull_power</span><span class="p">,</span> <span class="s2">&quot;bear_power&quot;</span><span class="p">:</span> <span class="n">bear_power</span><span class="p">,</span> <span class="s2">&quot;bbp&quot;</span><span class="p">:</span> <span class="n">bbp</span><span class="p">}</span></div>



<span class="c1"># Volatility/Bands</span>
<div class="viewcode-block" id="BollingerBands">
<a class="viewcode-back" href="../../utils.html#utils.indicators.BollingerBands">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">BollingerBands</span><span class="p">(</span><span class="n">values</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span> <span class="n">std</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Bollinger Bands - SMA with std dev bands.&quot;&quot;&quot;</span>
    <span class="n">values_series</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
    <span class="n">sma</span> <span class="o">=</span> <span class="n">SMA</span><span class="p">(</span><span class="n">values_series</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
    <span class="n">rolling_std</span> <span class="o">=</span> <span class="n">values_series</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>

    <span class="n">upper</span> <span class="o">=</span> <span class="n">sma</span> <span class="o">+</span> <span class="p">(</span><span class="n">rolling_std</span> <span class="o">*</span> <span class="n">std</span><span class="p">)</span>
    <span class="n">lower</span> <span class="o">=</span> <span class="n">sma</span> <span class="o">-</span> <span class="p">(</span><span class="n">rolling_std</span> <span class="o">*</span> <span class="n">std</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;upper&quot;</span><span class="p">:</span> <span class="n">upper</span><span class="p">,</span> <span class="s2">&quot;middle&quot;</span><span class="p">:</span> <span class="n">sma</span><span class="p">,</span> <span class="s2">&quot;lower&quot;</span><span class="p">:</span> <span class="n">lower</span><span class="p">}</span></div>



<div class="viewcode-block" id="Envelope">
<a class="viewcode-back" href="../../utils.html#utils.indicators.Envelope">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">Envelope</span><span class="p">(</span>
    <span class="n">close</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span> <span class="n">percent</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">10.0</span><span class="p">,</span> <span class="n">use_ema</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Envelope - MA with percentage bands.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">use_ema</span><span class="p">:</span>
        <span class="n">basis</span> <span class="o">=</span> <span class="n">EMA</span><span class="p">(</span><span class="n">close</span><span class="p">,</span> <span class="n">period</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">basis</span> <span class="o">=</span> <span class="n">SMA</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">close</span><span class="p">),</span> <span class="n">period</span><span class="p">)</span>

    <span class="n">basis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">k</span> <span class="o">=</span> <span class="n">percent</span> <span class="o">/</span> <span class="mf">100.0</span>
    <span class="n">upper</span> <span class="o">=</span> <span class="n">basis</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">k</span><span class="p">)</span>
    <span class="n">lower</span> <span class="o">=</span> <span class="n">basis</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">k</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;basis&quot;</span><span class="p">:</span> <span class="n">basis</span><span class="p">,</span> <span class="s2">&quot;upper&quot;</span><span class="p">:</span> <span class="n">upper</span><span class="p">,</span> <span class="s2">&quot;lower&quot;</span><span class="p">:</span> <span class="n">lower</span><span class="p">}</span></div>



<div class="viewcode-block" id="KeltnerChannels">
<a class="viewcode-back" href="../../utils.html#utils.indicators.KeltnerChannels">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">KeltnerChannels</span><span class="p">(</span>
    <span class="n">high</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">low</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">close</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
    <span class="n">multiplier</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Keltner Channels - EMA with ATR bands.&quot;&quot;&quot;</span>
    <span class="n">ema</span> <span class="o">=</span> <span class="n">EMA</span><span class="p">(</span><span class="n">close</span><span class="p">,</span> <span class="n">period</span><span class="p">)</span>
    <span class="n">atr</span> <span class="o">=</span> <span class="n">ATR</span><span class="p">(</span><span class="n">high</span><span class="p">,</span> <span class="n">low</span><span class="p">,</span> <span class="n">close</span><span class="p">,</span> <span class="n">period</span><span class="p">)</span>

    <span class="n">upper</span> <span class="o">=</span> <span class="n">ema</span> <span class="o">+</span> <span class="p">(</span><span class="n">multiplier</span> <span class="o">*</span> <span class="n">atr</span><span class="p">)</span>
    <span class="n">lower</span> <span class="o">=</span> <span class="n">ema</span> <span class="o">-</span> <span class="p">(</span><span class="n">multiplier</span> <span class="o">*</span> <span class="n">atr</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;upper&quot;</span><span class="p">:</span> <span class="n">upper</span><span class="p">,</span> <span class="s2">&quot;middle&quot;</span><span class="p">:</span> <span class="n">ema</span><span class="p">,</span> <span class="s2">&quot;lower&quot;</span><span class="p">:</span> <span class="n">lower</span><span class="p">}</span></div>



<span class="c1"># Special/Advanced</span>
<div class="viewcode-block" id="ParabolicSAR">
<a class="viewcode-back" href="../../utils.html#utils.indicators.ParabolicSAR">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">ParabolicSAR</span><span class="p">(</span>
    <span class="n">high</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">low</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">close</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">start</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.02</span><span class="p">,</span>
    <span class="n">increment</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.02</span><span class="p">,</span>
    <span class="n">maximum</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Parabolic SAR - Stop and Reversal indicator.&quot;&quot;&quot;</span>
    <span class="n">sar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">high</span><span class="p">)</span>
    <span class="n">trend</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">high</span><span class="p">)</span>
    <span class="n">af</span> <span class="o">=</span> <span class="n">start</span>
    <span class="n">ep</span> <span class="o">=</span> <span class="n">high</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">sar</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">low</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">high</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">trend</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">sar</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sar</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">af</span> <span class="o">*</span> <span class="p">(</span><span class="n">ep</span> <span class="o">-</span> <span class="n">sar</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">high</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">ep</span><span class="p">:</span>
                <span class="n">ep</span> <span class="o">=</span> <span class="n">high</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">af</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">af</span> <span class="o">+</span> <span class="n">increment</span><span class="p">,</span> <span class="n">maximum</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">low</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">sar</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                <span class="n">trend</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                <span class="n">sar</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ep</span>
                <span class="n">ep</span> <span class="o">=</span> <span class="n">low</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">af</span> <span class="o">=</span> <span class="n">start</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">trend</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">sar</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sar</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">af</span> <span class="o">*</span> <span class="p">(</span><span class="n">ep</span> <span class="o">-</span> <span class="n">sar</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">low</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">ep</span><span class="p">:</span>
                <span class="n">ep</span> <span class="o">=</span> <span class="n">low</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">af</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">af</span> <span class="o">+</span> <span class="n">increment</span><span class="p">,</span> <span class="n">maximum</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">high</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">sar</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                <span class="n">trend</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">sar</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ep</span>
                <span class="n">ep</span> <span class="o">=</span> <span class="n">high</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">af</span> <span class="o">=</span> <span class="n">start</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">trend</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

    <span class="k">return</span> <span class="n">sar</span></div>



<span class="c1"># Utilities</span>
<div class="viewcode-block" id="crossover">
<a class="viewcode-back" href="../../utils.html#utils.indicators.crossover">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">crossover</span><span class="p">(</span><span class="n">series1</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">series2</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return True where series1 crosses over series2.&quot;&quot;&quot;</span>
    <span class="n">series1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">series1</span><span class="p">)</span>
    <span class="n">series2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">series2</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">series2</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">series1</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">series2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">series1</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">&gt;</span> <span class="n">series2</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">series1</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">series2</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">series1</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">&gt;</span> <span class="n">series2</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span></div>



<div class="viewcode-block" id="crossunder">
<a class="viewcode-back" href="../../utils.html#utils.indicators.crossunder">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">crossunder</span><span class="p">(</span><span class="n">series1</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">series2</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return True where series1 crosses under series2.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">crossover</span><span class="p">(</span><span class="n">series2</span><span class="p">,</span> <span class="n">series1</span><span class="p">)</span></div>



<div class="viewcode-block" id="true_range">
<a class="viewcode-back" href="../../utils.html#utils.indicators.true_range">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">true_range</span><span class="p">(</span><span class="n">high</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">low</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">close</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate True Range for ATR calculations.&quot;&quot;&quot;</span>
    <span class="n">tr1</span> <span class="o">=</span> <span class="n">high</span> <span class="o">-</span> <span class="n">low</span>
    <span class="n">tr2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">high</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">close</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">tr3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">low</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">close</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

    <span class="n">tr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">tr1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">tr2</span><span class="p">,</span> <span class="n">tr3</span><span class="p">))</span>
    <span class="n">tr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">tr1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">tr</span></div>



<span class="c1"># Utility Functions (Performance &amp; Support)</span>


<div class="viewcode-block" id="max_drawdown">
<a class="viewcode-back" href="../../utils.html#utils.indicators.max_drawdown">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">max_drawdown</span><span class="p">(</span><span class="n">equity_curve</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate maximum drawdown.</span>

<span class="sd">    Args:</span>
<span class="sd">        equity_curve: Equity curve series</span>

<span class="sd">    Returns:</span>
<span class="sd">        Dictionary with max drawdown info</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">running_max</span> <span class="o">=</span> <span class="n">equity_curve</span><span class="o">.</span><span class="n">cummax</span><span class="p">()</span>
    <span class="n">drawdown</span> <span class="o">=</span> <span class="p">(</span><span class="n">equity_curve</span> <span class="o">-</span> <span class="n">running_max</span><span class="p">)</span> <span class="o">/</span> <span class="n">running_max</span>

    <span class="n">max_dd</span> <span class="o">=</span> <span class="n">drawdown</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="n">max_dd_end</span> <span class="o">=</span> <span class="n">drawdown</span><span class="o">.</span><span class="n">idxmin</span><span class="p">()</span>
    <span class="n">max_dd_start</span> <span class="o">=</span> <span class="n">equity_curve</span><span class="p">[:</span><span class="n">max_dd_end</span><span class="p">]</span><span class="o">.</span><span class="n">idxmax</span><span class="p">()</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;max_drawdown&quot;</span><span class="p">:</span> <span class="n">max_dd</span><span class="p">,</span>
        <span class="s2">&quot;start_date&quot;</span><span class="p">:</span> <span class="n">max_dd_start</span><span class="p">,</span>
        <span class="s2">&quot;end_date&quot;</span><span class="p">:</span> <span class="n">max_dd_end</span><span class="p">,</span>
        <span class="s2">&quot;duration&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">max_dd_end</span> <span class="o">-</span> <span class="n">max_dd_start</span><span class="p">)</span><span class="o">.</span><span class="n">days</span><span class="p">,</span>
    <span class="p">}</span></div>



<div class="viewcode-block" id="percent_rank">
<a class="viewcode-back" href="../../utils.html#utils.indicators.percent_rank">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">percent_rank</span><span class="p">(</span><span class="n">values</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">n</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Percentile rank of values over rolling window.</span>

<span class="sd">    Args:</span>
<span class="sd">        values: Input array</span>
<span class="sd">        n: Window size</span>

<span class="sd">    Returns:</span>
<span class="sd">        Percentile rank array (0-100)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)):</span>
        <span class="n">window</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="n">n</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">current</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">rank</span> <span class="o">=</span> <span class="p">(</span><span class="n">window</span> <span class="o">&lt;</span> <span class="n">current</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">window</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
        <span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">rank</span>

    <span class="k">return</span> <span class="n">result</span></div>



<div class="viewcode-block" id="renko_bars">
<a class="viewcode-back" href="../../utils.html#utils.indicators.renko_bars">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">renko_bars</span><span class="p">(</span>
    <span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">brick_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">percentage</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate Renko bars from OHLC data.</span>

<span class="sd">    Args:</span>
<span class="sd">        data: OHLC DataFrame</span>
<span class="sd">        brick_size: Size of each brick (auto-calculated if None)</span>
<span class="sd">        percentage: Whether brick_size is percentage (default: False)</span>

<span class="sd">    Returns:</span>
<span class="sd">        DataFrame with Renko bars</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">brick_size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Auto-calculate brick size as 1% of average price</span>
        <span class="n">avg_price</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;Close&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">brick_size</span> <span class="o">=</span> <span class="n">avg_price</span> <span class="o">*</span> <span class="mf">0.01</span>

    <span class="n">close_prices</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;Close&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">renko_data</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">close_prices</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

    <span class="n">current_brick</span> <span class="o">=</span> <span class="n">close_prices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">price</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">close_prices</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">percentage</span><span class="p">:</span>
            <span class="n">threshold</span> <span class="o">=</span> <span class="n">current_brick</span> <span class="o">*</span> <span class="n">brick_size</span> <span class="o">/</span> <span class="mi">100</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">threshold</span> <span class="o">=</span> <span class="n">brick_size</span>

        <span class="c1"># Check for new brick formation</span>
        <span class="k">if</span> <span class="n">price</span> <span class="o">&gt;=</span> <span class="n">current_brick</span> <span class="o">+</span> <span class="n">threshold</span><span class="p">:</span>
            <span class="c1"># Upward brick(s)</span>
            <span class="k">while</span> <span class="n">price</span> <span class="o">&gt;=</span> <span class="n">current_brick</span> <span class="o">+</span> <span class="n">threshold</span><span class="p">:</span>
                <span class="n">new_brick</span> <span class="o">=</span> <span class="n">current_brick</span> <span class="o">+</span> <span class="n">threshold</span>
                <span class="n">renko_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                        <span class="s2">&quot;open&quot;</span><span class="p">:</span> <span class="n">current_brick</span><span class="p">,</span>
                        <span class="s2">&quot;close&quot;</span><span class="p">:</span> <span class="n">new_brick</span><span class="p">,</span>
                        <span class="s2">&quot;direction&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                    <span class="p">}</span>
                <span class="p">)</span>
                <span class="n">current_brick</span> <span class="o">=</span> <span class="n">new_brick</span>

        <span class="k">elif</span> <span class="n">price</span> <span class="o">&lt;=</span> <span class="n">current_brick</span> <span class="o">-</span> <span class="n">threshold</span><span class="p">:</span>
            <span class="c1"># Downward brick(s)</span>
            <span class="k">while</span> <span class="n">price</span> <span class="o">&lt;=</span> <span class="n">current_brick</span> <span class="o">-</span> <span class="n">threshold</span><span class="p">:</span>
                <span class="n">new_brick</span> <span class="o">=</span> <span class="n">current_brick</span> <span class="o">-</span> <span class="n">threshold</span>
                <span class="n">renko_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                        <span class="s2">&quot;open&quot;</span><span class="p">:</span> <span class="n">current_brick</span><span class="p">,</span>
                        <span class="s2">&quot;close&quot;</span><span class="p">:</span> <span class="n">new_brick</span><span class="p">,</span>
                        <span class="s2">&quot;direction&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="p">}</span>
                <span class="p">)</span>
                <span class="n">current_brick</span> <span class="o">=</span> <span class="n">new_brick</span>

    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">renko_data</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;timestamp&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="resample_apply">
<a class="viewcode-back" href="../../utils.html#utils.indicators.resample_apply">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">resample_apply</span><span class="p">(</span><span class="n">rule</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">apply_func</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Resample OHLCV data to different timeframes.</span>

<span class="sd">    Args:</span>
<span class="sd">        rule: Pandas resample rule (e.g., &quot;1H&quot;, &quot;1D&quot;, &quot;1W&quot;)</span>
<span class="sd">        data: OHLCV DataFrame with DatetimeIndex</span>
<span class="sd">        apply_func: Optional function to apply to resampled data</span>

<span class="sd">    Returns:</span>
<span class="sd">        Resampled DataFrame</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DatetimeIndex</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Data must have DatetimeIndex for resampling&quot;</span><span class="p">)</span>

    <span class="c1"># Define resampling logic for OHLCV data</span>
    <span class="n">agg_dict</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">if</span> <span class="s2">&quot;Open&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">agg_dict</span><span class="p">[</span><span class="s2">&quot;Open&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;first&quot;</span>
    <span class="k">if</span> <span class="s2">&quot;High&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">agg_dict</span><span class="p">[</span><span class="s2">&quot;High&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;max&quot;</span>
    <span class="k">if</span> <span class="s2">&quot;Low&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">agg_dict</span><span class="p">[</span><span class="s2">&quot;Low&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;min&quot;</span>
    <span class="k">if</span> <span class="s2">&quot;Close&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">agg_dict</span><span class="p">[</span><span class="s2">&quot;Close&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;last&quot;</span>
    <span class="k">if</span> <span class="s2">&quot;Volume&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">agg_dict</span><span class="p">[</span><span class="s2">&quot;Volume&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;sum&quot;</span>

    <span class="c1"># Add any other numeric columns with mean aggregation</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">agg_dict</span> <span class="ow">and</span> <span class="n">pd</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">is_numeric_dtype</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">]):</span>
            <span class="n">agg_dict</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;mean&quot;</span>

    <span class="n">resampled</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">rule</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">agg_dict</span><span class="p">)</span>

    <span class="c1"># Apply custom function if provided</span>
    <span class="k">if</span> <span class="n">apply_func</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">resampled</span> <span class="o">=</span> <span class="n">apply_func</span><span class="p">(</span><span class="n">resampled</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">resampled</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span></div>



<div class="viewcode-block" id="rolling_window">
<a class="viewcode-back" href="../../utils.html#utils.indicators.rolling_window">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">rolling_window</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">window</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create rolling window view of data for vectorized operations.</span>

<span class="sd">    Args:</span>
<span class="sd">        data: Input array</span>
<span class="sd">        window: Window size</span>

<span class="sd">    Returns:</span>
<span class="sd">        2D array where each row is a rolling window</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">window</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Window size cannot be larger than data length&quot;</span><span class="p">)</span>

    <span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">-</span> <span class="n">window</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">window</span><span class="p">)</span>
    <span class="n">strides</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">strides</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">data</span><span class="o">.</span><span class="n">strides</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">stride_tricks</span><span class="o">.</span><span class="n">as_strided</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span> <span class="n">strides</span><span class="o">=</span><span class="n">strides</span><span class="p">)</span></div>



<div class="viewcode-block" id="sharpe_ratio">
<a class="viewcode-back" href="../../utils.html#utils.indicators.sharpe_ratio">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">sharpe_ratio</span><span class="p">(</span><span class="n">returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">risk_free_rate</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.05</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate Sharpe ratio.</span>

<span class="sd">    Args:</span>
<span class="sd">        returns: Return series (annualized)</span>
<span class="sd">        risk_free_rate: Risk-free rate (default: 5% annually)</span>

<span class="sd">    Returns:</span>
<span class="sd">        Sharpe ratio</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">excess_returns</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">-</span> <span class="n">risk_free_rate</span>
    <span class="k">return</span> <span class="n">excess_returns</span> <span class="o">/</span> <span class="n">returns</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="k">if</span> <span class="n">returns</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span></div>



<div class="viewcode-block" id="volatility_adjusted_returns">
<a class="viewcode-back" href="../../utils.html#utils.indicators.volatility_adjusted_returns">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">volatility_adjusted_returns</span><span class="p">(</span><span class="n">returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">window</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate volatility-adjusted returns (returns / volatility).</span>

<span class="sd">    Args:</span>
<span class="sd">        returns: Return series</span>
<span class="sd">        window: Rolling window for volatility calculation</span>

<span class="sd">    Returns:</span>
<span class="sd">        Volatility-adjusted returns</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">volatility</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">returns</span> <span class="o">/</span> <span class="n">volatility</span></div>



<span class="c1"># Commonly used technical indicator presets</span>
<span class="n">COMMON_INDICATORS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;sma_fast&quot;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">close</span><span class="p">:</span> <span class="n">SMA</span><span class="p">(</span><span class="n">close</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
    <span class="s2">&quot;sma_slow&quot;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">close</span><span class="p">:</span> <span class="n">SMA</span><span class="p">(</span><span class="n">close</span><span class="p">,</span> <span class="mi">30</span><span class="p">),</span>
    <span class="s2">&quot;ema_fast&quot;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">close</span><span class="p">:</span> <span class="n">EMA</span><span class="p">(</span><span class="n">close</span><span class="p">,</span> <span class="mi">12</span><span class="p">),</span>
    <span class="s2">&quot;ema_slow&quot;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">close</span><span class="p">:</span> <span class="n">EMA</span><span class="p">(</span><span class="n">close</span><span class="p">,</span> <span class="mi">26</span><span class="p">),</span>
    <span class="s2">&quot;rsi&quot;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">close</span><span class="p">:</span> <span class="n">RSI</span><span class="p">(</span><span class="n">close</span><span class="p">,</span> <span class="mi">14</span><span class="p">),</span>
    <span class="s2">&quot;macd&quot;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">close</span><span class="p">:</span> <span class="n">MACD</span><span class="p">(</span><span class="n">close</span><span class="p">),</span>
    <span class="s2">&quot;bb&quot;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">close</span><span class="p">:</span> <span class="n">BollingerBands</span><span class="p">(</span><span class="n">close</span><span class="p">),</span>
<span class="p">}</span>


<div class="viewcode-block" id="apply_indicators">
<a class="viewcode-back" href="../../utils.html#utils.indicators.apply_indicators">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">apply_indicators</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">indicators</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Apply multiple technical indicators to OHLC data.</span>

<span class="sd">    Args:</span>
<span class="sd">        data: OHLC DataFrame</span>
<span class="sd">        indicators: List of indicator names or functions</span>

<span class="sd">    Returns:</span>
<span class="sd">        DataFrame with additional indicator columns</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">indicators</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">indicators</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;sma_fast&quot;</span><span class="p">,</span> <span class="s2">&quot;sma_slow&quot;</span><span class="p">,</span> <span class="s2">&quot;rsi&quot;</span><span class="p">]</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">indicator</span> <span class="ow">in</span> <span class="n">indicators</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">indicator</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">indicator</span> <span class="ow">in</span> <span class="n">COMMON_INDICATORS</span><span class="p">:</span>
            <span class="n">func</span> <span class="o">=</span> <span class="n">COMMON_INDICATORS</span><span class="p">[</span><span class="n">indicator</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">indicator</span><span class="o">.</span><span class="n">startswith</span><span class="p">((</span><span class="s2">&quot;sma&quot;</span><span class="p">,</span> <span class="s2">&quot;ema&quot;</span><span class="p">,</span> <span class="s2">&quot;rsi&quot;</span><span class="p">)):</span>
                <span class="n">result</span><span class="p">[</span><span class="n">indicator</span><span class="p">]</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;Close&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">indicator</span> <span class="o">==</span> <span class="s2">&quot;macd&quot;</span><span class="p">:</span>
                <span class="n">macd_data</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;Close&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
                <span class="n">result</span><span class="p">[</span><span class="s2">&quot;macd&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">macd_data</span><span class="p">[</span><span class="s2">&quot;macd&quot;</span><span class="p">]</span>
                <span class="n">result</span><span class="p">[</span><span class="s2">&quot;macd_signal&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">macd_data</span><span class="p">[</span><span class="s2">&quot;signal&quot;</span><span class="p">]</span>
                <span class="n">result</span><span class="p">[</span><span class="s2">&quot;macd_histogram&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">macd_data</span><span class="p">[</span><span class="s2">&quot;histogram&quot;</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">indicator</span> <span class="o">==</span> <span class="s2">&quot;bb&quot;</span><span class="p">:</span>
                <span class="n">bb_data</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;Close&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
                <span class="n">result</span><span class="p">[</span><span class="s2">&quot;bb_upper&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bb_data</span><span class="p">[</span><span class="s2">&quot;upper&quot;</span><span class="p">]</span>
                <span class="n">result</span><span class="p">[</span><span class="s2">&quot;bb_middle&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bb_data</span><span class="p">[</span><span class="s2">&quot;middle&quot;</span><span class="p">]</span>
                <span class="n">result</span><span class="p">[</span><span class="s2">&quot;bb_lower&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bb_data</span><span class="p">[</span><span class="s2">&quot;lower&quot;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">callable</span><span class="p">(</span><span class="n">indicator</span><span class="p">):</span>
            <span class="c1"># Custom function</span>
            <span class="n">result</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;custom_</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">indicator</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">result</span></div>



<div class="viewcode-block" id="extract_ichimoku_base_line">
<a class="viewcode-back" href="../../utils.html#utils.indicators.extract_ichimoku_base_line">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">extract_ichimoku_base_line</span><span class="p">(</span>
    <span class="n">high</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">low</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">26</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extract Ichimoku Base Line (Kijun-sen).</span>

<span class="sd">    Args:</span>
<span class="sd">        high: High prices</span>
<span class="sd">        low: Low prices</span>
<span class="sd">        period: Period (default: 26)</span>

<span class="sd">    Returns:</span>
<span class="sd">        Ichimoku Base Line values</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">high_series</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">high</span><span class="p">)</span>
    <span class="n">low_series</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">low</span><span class="p">)</span>

    <span class="n">highest_high</span> <span class="o">=</span> <span class="n">high_series</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">period</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">lowest_low</span> <span class="o">=</span> <span class="n">low_series</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">period</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>

    <span class="n">base_line</span> <span class="o">=</span> <span class="p">(</span><span class="n">highest_high</span> <span class="o">+</span> <span class="n">lowest_low</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>

    <span class="k">return</span> <span class="n">base_line</span><span class="o">.</span><span class="n">values</span></div>



<div class="viewcode-block" id="calculate_stochastic_slow">
<a class="viewcode-back" href="../../utils.html#utils.indicators.calculate_stochastic_slow">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">calculate_stochastic_slow</span><span class="p">(</span>
    <span class="n">high</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">low</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">close</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">k_period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
    <span class="n">d_period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
    <span class="n">smooth_k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate Stochastic Slow oscillator.</span>

<span class="sd">    Args:</span>
<span class="sd">        high: High prices</span>
<span class="sd">        low: Low prices</span>
<span class="sd">        close: Close prices</span>
<span class="sd">        k_period: %K period (default: 5)</span>
<span class="sd">        d_period: %D period (default: 3)</span>
<span class="sd">        smooth_k: %K smoothing (default: 3)</span>

<span class="sd">    Returns:</span>
<span class="sd">        Dictionary with slow_k and slow_d values</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Calculate Fast %K (raw stochastic)</span>
    <span class="n">high_series</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">high</span><span class="p">)</span>
    <span class="n">low_series</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">low</span><span class="p">)</span>
    <span class="n">close_series</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">close</span><span class="p">)</span>

    <span class="n">lowest_low</span> <span class="o">=</span> <span class="n">low_series</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">k_period</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="n">highest_high</span> <span class="o">=</span> <span class="n">high_series</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">k_period</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

    <span class="n">fast_k</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="p">(</span><span class="n">close_series</span> <span class="o">-</span> <span class="n">lowest_low</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">highest_high</span> <span class="o">-</span> <span class="n">lowest_low</span><span class="p">)</span>

    <span class="c1"># Slow %K is SMA of Fast %K</span>
    <span class="n">slow_k</span> <span class="o">=</span> <span class="n">fast_k</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">smooth_k</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

    <span class="c1"># Slow %D is SMA of Slow %K</span>
    <span class="n">slow_d</span> <span class="o">=</span> <span class="n">slow_k</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">d_period</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;slow_k&quot;</span><span class="p">:</span> <span class="n">slow_k</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="s2">&quot;slow_d&quot;</span><span class="p">:</span> <span class="n">slow_d</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">}</span></div>



<div class="viewcode-block" id="HMA">
<a class="viewcode-back" href="../../utils.html#utils.indicators.HMA">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">HMA</span><span class="p">(</span><span class="n">close</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">14</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Hull Moving Average - provides reduced lag compared to traditional MAs.</span>

<span class="sd">    Args:</span>
<span class="sd">        close: Close prices</span>
<span class="sd">        period: Period (default: 14)</span>

<span class="sd">    Returns:</span>
<span class="sd">        HMA values</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">half_period</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">period</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">sqrt_period</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">period</span><span class="p">))</span>

    <span class="n">wma_half</span> <span class="o">=</span> <span class="n">WMA</span><span class="p">(</span><span class="n">close</span><span class="p">,</span> <span class="n">half_period</span><span class="p">)</span>
    <span class="n">wma_full</span> <span class="o">=</span> <span class="n">WMA</span><span class="p">(</span><span class="n">close</span><span class="p">,</span> <span class="n">period</span><span class="p">)</span>

    <span class="n">raw_hma</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">wma_half</span> <span class="o">-</span> <span class="n">wma_full</span>
    <span class="n">hma</span> <span class="o">=</span> <span class="n">WMA</span><span class="p">(</span><span class="n">raw_hma</span><span class="p">,</span> <span class="n">sqrt_period</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">hma</span></div>



<div class="viewcode-block" id="MomentumOscillator">
<a class="viewcode-back" href="../../utils.html#utils.indicators.MomentumOscillator">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">MomentumOscillator</span><span class="p">(</span><span class="n">close</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">14</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Momentum Oscillator - rate of change indicator.</span>

<span class="sd">    Args:</span>
<span class="sd">        close: Close prices</span>
<span class="sd">        period: Period (default: 14)</span>

<span class="sd">    Returns:</span>
<span class="sd">        Momentum values</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">momentum</span> <span class="o">=</span> <span class="n">close</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">close</span><span class="p">,</span> <span class="n">period</span><span class="p">)</span>
    <span class="n">momentum</span><span class="p">[:</span><span class="n">period</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Set initial values to 0</span>
    <span class="k">return</span> <span class="n">momentum</span></div>



<div class="viewcode-block" id="TrendClassification">
<a class="viewcode-back" href="../../utils.html#utils.indicators.TrendClassification">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">TrendClassification</span><span class="p">(</span><span class="n">aroon_up</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">aroon_down</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">25</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Classify trend using Aroon indicator with period-adaptive thresholds.</span>
<span class="sd">    </span>
<span class="sd">    Longer periods need more relaxed thresholds (slower to change classification).</span>
<span class="sd">    Shorter periods use stricter thresholds (quicker to identify trends).</span>

<span class="sd">    Args:</span>
<span class="sd">        aroon_up: Aroon Up value (0-100)</span>
<span class="sd">        aroon_down: Aroon Down value (0-100)</span>
<span class="sd">        period: Aroon period length (default: 25)</span>

<span class="sd">    Returns:</span>
<span class="sd">        Trend classification: &quot;Bull&quot;, &quot;Bear&quot;, or &quot;Sideways&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Period-adaptive thresholds</span>
    <span class="k">if</span> <span class="n">period</span> <span class="o">&lt;=</span> <span class="mi">25</span><span class="p">:</span>
        <span class="c1"># Short-term: Strict thresholds (quick reaction)</span>
        <span class="n">bull_threshold</span> <span class="o">=</span> <span class="mi">70</span>
        <span class="n">bear_threshold</span> <span class="o">=</span> <span class="mi">70</span>
        <span class="n">neutral_gap</span> <span class="o">=</span> <span class="mi">30</span>
    <span class="k">elif</span> <span class="n">period</span> <span class="o">&lt;=</span> <span class="mi">50</span><span class="p">:</span>
        <span class="c1"># Medium-term: Moderate thresholds</span>
        <span class="n">bull_threshold</span> <span class="o">=</span> <span class="mi">65</span>
        <span class="n">bear_threshold</span> <span class="o">=</span> <span class="mi">65</span>
        <span class="n">neutral_gap</span> <span class="o">=</span> <span class="mi">25</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Long-term: Relaxed thresholds (slow to classify)</span>
        <span class="n">bull_threshold</span> <span class="o">=</span> <span class="mi">60</span>
        <span class="n">bear_threshold</span> <span class="o">=</span> <span class="mi">60</span>
        <span class="n">neutral_gap</span> <span class="o">=</span> <span class="mi">20</span>
    
    <span class="c1"># Bull: Aroon Up dominates</span>
    <span class="k">if</span> <span class="n">aroon_up</span> <span class="o">&gt;</span> <span class="n">bull_threshold</span> <span class="ow">and</span> <span class="n">aroon_down</span> <span class="o">&lt;</span> <span class="n">neutral_gap</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;Bull&quot;</span>
    
    <span class="c1"># Bear: Aroon Down dominates</span>
    <span class="k">elif</span> <span class="n">aroon_down</span> <span class="o">&gt;</span> <span class="n">bear_threshold</span> <span class="ow">and</span> <span class="n">aroon_up</span> <span class="o">&lt;</span> <span class="n">neutral_gap</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;Bear&quot;</span>
    
    <span class="c1"># Sideways: Neither dominates clearly</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;Sideways&quot;</span></div>



<div class="viewcode-block" id="VolatilityClassification">
<a class="viewcode-back" href="../../utils.html#utils.indicators.VolatilityClassification">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">VolatilityClassification</span><span class="p">(</span><span class="n">atr_pct</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">14</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Classify volatility using ATR percentage with period-adaptive thresholds.</span>
<span class="sd">    </span>
<span class="sd">    Calibrated for Indian market volatility (higher than US markets).</span>
<span class="sd">    Longer periods show smoother/lower ATR, so need lower thresholds.</span>

<span class="sd">    Args:</span>
<span class="sd">        atr_pct: ATR as percentage of price</span>
<span class="sd">        period: ATR period length (default: 14)</span>

<span class="sd">    Returns:</span>
<span class="sd">        Volatility classification: &quot;Low&quot;, &quot;Med&quot;, or &quot;High&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Period-adaptive thresholds</span>
    <span class="k">if</span> <span class="n">period</span> <span class="o">&lt;=</span> <span class="mi">14</span><span class="p">:</span>
        <span class="c1"># Short-term ATR: Higher thresholds</span>
        <span class="n">low_threshold</span> <span class="o">=</span> <span class="mf">2.5</span>    <span class="c1"># Increased from 1.5 for Indian markets</span>
        <span class="n">high_threshold</span> <span class="o">=</span> <span class="mf">4.5</span>   <span class="c1"># Increased from 3.0</span>
    <span class="k">elif</span> <span class="n">period</span> <span class="o">&lt;=</span> <span class="mi">21</span><span class="p">:</span>
        <span class="c1"># Medium-term ATR</span>
        <span class="n">low_threshold</span> <span class="o">=</span> <span class="mf">2.2</span>
        <span class="n">high_threshold</span> <span class="o">=</span> <span class="mf">4.0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Long-term ATR: Lower thresholds (smoother values)</span>
        <span class="n">low_threshold</span> <span class="o">=</span> <span class="mf">2.0</span>
        <span class="n">high_threshold</span> <span class="o">=</span> <span class="mf">3.5</span>
    
    <span class="k">if</span> <span class="n">atr_pct</span> <span class="o">&lt;</span> <span class="n">low_threshold</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;Low&quot;</span>
    <span class="k">elif</span> <span class="n">atr_pct</span> <span class="o">&lt;</span> <span class="n">high_threshold</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;Med&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;High&quot;</span></div>



<div class="viewcode-block" id="kaufman_efficiency_ratio">
<a class="viewcode-back" href="../../utils.html#utils.indicators.kaufman_efficiency_ratio">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">kaufman_efficiency_ratio</span><span class="p">(</span><span class="n">close</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">length</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Kaufman Efficiency Ratio (KER) - measures trend strength vs noise.</span>

<span class="sd">    Identifies whether price is in a trending state (high KER) or noisy (low KER).</span>

<span class="sd">    Formula per Kaufman (as attached):</span>
<span class="sd">        ER = |Close[t] - Close[t-n]| / |Close[i] - Close[i-1]|  for i = t-n+1 to t</span>
<span class="sd">    </span>
<span class="sd">    Where:</span>
<span class="sd">        - Direction (numerator): absolute price change over n periods</span>
<span class="sd">        - Volatility (denominator): sum of all bar-to-bar absolute changes over n periods</span>
<span class="sd">        - ER range: 0 to 1 (1=perfect trending, 0=choppy/noisy)</span>

<span class="sd">    Args:</span>
<span class="sd">        close: Close prices array</span>
<span class="sd">        length: Lookback period (commonly 10). Uses exactly `length` bars of history.</span>

<span class="sd">    Returns:</span>
<span class="sd">        KER array (range 0.0 to 1.0). </span>
<span class="sd">        - Values &lt; 0.3: High noise (mean-reverting)</span>
<span class="sd">        - Values &gt; 0.7: Low noise (trending)</span>

<span class="sd">    Returns NaN for first `length` bars (insufficient data).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">close</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">close</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">close</span><span class="p">)</span>
    <span class="n">ker</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="c1"># Direction: absolute change from length bars ago to current</span>
        <span class="c1"># Window: [i-length, i] = exactly length+1 points, length bars of change</span>
        <span class="n">direction</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">close</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">close</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="n">length</span><span class="p">])</span>

        <span class="c1"># Volatility (noise): sum of ALL bar-to-bar absolute changes in window</span>
        <span class="c1"># Sum from bar i-length+1 to bar i (exactly length changes)</span>
        <span class="n">volatility</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="n">length</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">volatility</span> <span class="o">+=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">close</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">close</span><span class="p">[</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>

        <span class="c1"># Calculate KER</span>
        <span class="k">if</span> <span class="n">volatility</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ker</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">direction</span> <span class="o">/</span> <span class="n">volatility</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ker</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="k">return</span> <span class="n">ker</span></div>


<div class="viewcode-block" id="CHOP">
<a class="viewcode-back" href="../../utils.html#utils.indicators.CHOP">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">CHOP</span><span class="p">(</span><span class="n">high</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">low</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">close</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Choppiness Index (CHOP).</span>
<span class="sd">    </span>
<span class="sd">    Distinguishes between trending and range-bound (choppy) markets.</span>
<span class="sd">    </span>
<span class="sd">    Formula:</span>
<span class="sd">        CHOP = 100 * LOG10(SUM(ATR, n) / (MAX(High, n) - MIN(Low, n))) / LOG10(n)</span>
<span class="sd">    </span>
<span class="sd">    Where:</span>
<span class="sd">        - n = period (commonly 50)</span>
<span class="sd">        - SUM(ATR, n) = sum of true ranges over n periods</span>
<span class="sd">        - MAX(High, n) = highest high over n periods</span>
<span class="sd">        - MIN(Low, n) = lowest low over n periods</span>
<span class="sd">    </span>
<span class="sd">    Interpretation:</span>
<span class="sd">        - CHOP &gt; 61.8: Very Choppy (avoid entries, mean-reverting)</span>
<span class="sd">        - CHOP 38.2-61.8: Neutral (mixed conditions)</span>
<span class="sd">        - CHOP &lt; 38.2: Directional/Trending (good for entries)</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        high: High prices array</span>
<span class="sd">        low: Low prices array</span>
<span class="sd">        close: Close prices array</span>
<span class="sd">        period: CHOP period (default: 50)</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        CHOP array (range 0-100). NaN for first `period` bars.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">chop</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">close</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">close</span><span class="p">)):</span>
        <span class="n">high_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">high</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="n">period</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">low_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">low</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="n">period</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">atr_sum</span> <span class="o">=</span> <span class="mf">0.0</span>
        
        <span class="c1"># Calculate sum of true ranges</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="n">period</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">tr</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
                <span class="n">high</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">low</span><span class="p">[</span><span class="n">j</span><span class="p">],</span>
                <span class="nb">abs</span><span class="p">(</span><span class="n">high</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">close</span><span class="p">[</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]),</span>
                <span class="nb">abs</span><span class="p">(</span><span class="n">low</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">close</span><span class="p">[</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
            <span class="p">)</span>
            <span class="n">atr_sum</span> <span class="o">+=</span> <span class="n">tr</span>
        
        <span class="c1"># Calculate CHOP</span>
        <span class="k">if</span> <span class="n">high_max</span> <span class="o">&gt;</span> <span class="n">low_min</span> <span class="ow">and</span> <span class="n">atr_sum</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">chop</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">atr_sum</span> <span class="o">/</span> <span class="p">(</span><span class="n">high_max</span> <span class="o">-</span> <span class="n">low_min</span><span class="p">))</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">period</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">chop</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2026, QuantLab Team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>